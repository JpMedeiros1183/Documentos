<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Documentos Jurídicos com Assinatura</title>
    <style>
        /* ESTILOS GERAIS (iguais aos anteriores) */
        body {
            font-family: 'Times New Roman', Times, serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            background-color: #f5f5f5;
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            border-bottom: 2px solid #333;
            padding-bottom: 10px;
        }
        .form-container {
            background-color: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-row {
            display: flex;
            flex-wrap: wrap;
            margin: 0 -10px;
        }
        .form-col {
            flex: 1 0 200px;
            padding: 0 10px;
            margin-bottom: 15px;
        }
        .form-col-small {
            flex: 0 0 100px;
            padding: 0 10px;
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #444;
        }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-family: inherit;
            font-size: 14px;
        }
        .buttons {
            margin-top: 25px;
            text-align: center;
        }
        button {
            padding: 12px 25px;
            background-color: #003366;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.3s;
            margin: 0 5px;
        }
        button:hover {
            background-color: #00254d;
        }
        #documentosContainer {
            display: none;
            margin-top: 30px;
        }
        .documento-preview {
            background-color: white;
            padding: 40px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-radius: 8px;
            margin-bottom: 30px;
        }
        .documento {
            font-size: 11px;
            line-height: 1.2;
            text-align: justify;
        }
        .documento h2 {
            text-align: center;
            font-size: 11px;
            margin-top: 10px;
            margin-bottom: 8px;
            font-weight: bold;
        }
        .assinatura {
            margin-top: 40px;
            text-align: center;
        }
        .linha {
            display: block;
            width: 70%;
            border-bottom: 1px solid black;
            margin: 0 auto 5px auto;
            height: 1px;
        }
         .assinatura img + .linha { display: none; }
        .assinatura img {
            display: block;
            margin: 5px auto 0 auto;
            max-width: 250px;
            height: auto;
            border-bottom: 1px solid #555;
            padding-bottom: 3px;
        }
         .assinatura p {
             margin-top: 3px;
             font-size: 10px;
             line-height: 1.2;
         }
        .audit-trail {
            font-size: 8px;
            color: #555;
            margin-top: 4px;
            line-height: 1.1;
            text-align: center;
            font-family: Arial, sans-serif;
            word-wrap: break-word;
        }
        .data {
            text-align: right;
            margin: 20px 0 15px;
        }
        .timbre {
            text-align: center;
            margin-bottom: 15px;
            font-size: 11px;
            color: #555;
        }
        .required:after { content: " *"; color: red; }
        .tipo-pessoa { display: flex; gap: 20px; margin-bottom: 20px; justify-content: center; }
        .tipo-pessoa label { display: inline-flex; align-items: center; cursor: pointer; }
        .tipo-pessoa input { width: auto; margin-right: 5px; }
        .section-title { margin-top: 25px; padding-bottom: 10px; border-bottom: 1px solid #ddd; }
        #pessoaJuridicaFields { display: none; padding: 15px; background-color: #f9f9f9; border-radius: 5px; margin-bottom: 20px; border: 1px solid #eee; }
        .header-container { text-align: center; margin-bottom: 15px; }
        .header-title { font-size: 14px; font-weight: bold; color: #003366; margin-bottom: 4px; }
        .header-subtitle { font-size: 11px; color: #666; }
        .documento p { margin-top: 0.3em; margin-bottom: 0.3em; }
        .documento ul { padding-left: 20px; margin: 5px 0; }
        .documento ul li { margin: 2px 0; }

        /* Seção para escolha do documento */
        .doc-selection { margin: 20px 0; padding: 15px; background-color: #f0f7ff; border-radius: 5px; border: 1px solid #d0e5ff; }
        .doc-selection h3 { margin-top: 0; color: #003366; }
        .doc-options { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 15px; }
        .doc-option { flex: 1 0 200px; border: 1px solid #ccc; border-radius: 5px; padding: 15px; background-color: white; transition: all 0.3s; }
        .doc-option:hover { border-color: #003366; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .doc-option.selected { border-color: #003366; background-color: #e6eeff; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .doc-option h4 { margin: 0 0 10px 0; color: #003366; display: inline-block; }
        .doc-option p { font-size: 13px; color: #666; margin: 5px 0; }
        .doc-checkbox-wrapper { display: flex; align-items: center; margin-bottom: 10px; }
        .doc-checkbox { margin-right: 10px; width: 20px !important; height: 20px !important; cursor: pointer; }

        /* Campos específicos */
        .documento-fields { display: none; margin-top: 20px; padding: 15px; background-color: #f9f9f9; border-radius: 5px; border: 1px solid #eee; }

        /* Título e botões do preview */
        .doc-title { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .doc-title h3 { margin: 0; color: #003366; }
        .doc-title .doc-buttons { display: flex; gap: 10px; }
        .doc-title .doc-buttons button { padding: 8px 15px; font-size: 14px; }

        /* --- ESTILOS PARA ASSINATURA (Modal) --- */
        #assinaturaModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); z-index: 1050; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 10px; box-sizing: border-box; }
        .modal-content { background-color: white; padding: 20px; border-radius: 5px; width: 100%; max-width: 800px; height: 90%; display: flex; flex-direction: column; box-sizing: border-box; }
        .signature-pad-container { flex-grow: 1; border: 1px solid #ccc; margin-bottom: 10px; position: relative; background-color: #eee; }
        #signature-canvas { width: 100%; height: 100%; display: block; cursor: crosshair; }
        .modal-buttons { display: flex; justify-content: space-around; gap: 10px; flex-wrap: wrap; }
        .modal-buttons button { padding: 10px 20px; font-size: 14px; }

        /* --- MEDIA QUERIES (Responsivo) --- */
        @media screen and (max-width: 767px) {
            .form-container { padding: 15px; }
            .form-row { flex-direction: column; }
            .form-col, .form-col-small { flex: 1 0 100%; }
            .tipo-pessoa { flex-direction: column; align-items: flex-start; gap: 10px; }
            button { padding: 15px 20px; margin: 10px 0; width: 100%; }
            .doc-options { flex-direction: column; }
            .doc-option { flex: 1 0 100%; }
            .documento-preview { padding: 20px; }
            .doc-title { flex-direction: column; gap: 10px; }
            .doc-title .doc-buttons { width: 100%; }
            .doc-title .doc-buttons button { flex: 1; }
            .modal-content { height: 85%; }
            .modal-buttons { flex-direction: column; }
        }

        /* --- ESTILOS DE IMPRESSÃO OTIMIZADOS --- */
        @media print {
            body {
                background-color: white;
                max-width: none;
                padding: 0; /* Removido padding padrão do body para impressão */
                font-size: 9.5pt; /* Reduzido levemente o tamanho base */
                line-height: 1.15; /* Reduzido levemente o espaçamento entre linhas */
            }
            @page {
                 size: A4;
                 margin: 18mm 15mm 15mm 15mm; /* Margens ligeiramente reduzidas (top, right, bottom, left) */
            }
            .form-container, .noPrint, #assinaturaModal {
                display: none !important;
            }
            #documentosContainer {
                display: block !important;
                margin-top: 0;
            }
            .documento-preview {
                box-shadow: none;
                border: none;
                padding: 0;
                margin-bottom: 10mm; /* Reduzido espaço entre documentos */
                page-break-after: always;
                page-break-inside: avoid; /* Tenta evitar que o preview em si quebre */
            }
            .documento-preview:last-child {
                 page-break-after: avoid;
            }
            button { display: none !important; }

             /* Ajustes finos para conteúdo do documento na impressão */
             .documento { font-size: 9.5pt; line-height: 1.15;} /* Mantém consistência com body */
             .documento h2 { font-size: 9.5pt; margin: 10px 0 6px; } /* Margem reduzida */
             .documento p {
                margin: 0.3em 0; /* Margem vertical de parágrafo reduzida */
                orphans: 3; /* Mínimo 3 linhas no fim da página */
                widows: 3;  /* Mínimo 3 linhas no topo da página */
             }
             .documento ul { padding-left: 18px; margin: 4px 0; } /* Reduzido padding/margin */
             .documento ul li { margin: 1px 0; } /* Reduzido margin */

             .assinatura {
                 margin-top: 20mm; /* Reduzido espaço antes da assinatura */
                 text-align: center;
                 page-break-inside: avoid !important; /* Força evitar quebra DENTRO da assinatura */
            }
             .assinatura img { max-width: 160px; border-bottom: 1px solid #333; padding-bottom: 2px; } /* Imagem menor */
             .assinatura p { font-size: 8.5pt; margin-top: 1px; } /* Fonte menor */
             .audit-trail {
                 font-size: 6.5pt; /* Muito pequeno, mas economiza espaço */
                 color: #444;
                 margin-top: 3px;
                 line-height: 1.0;
                 font-family: Arial, sans-serif;
                 page-break-inside: avoid; /* Evita quebrar DENTRO da auditoria */
             }
             .linha { border-bottom: 1px solid black; }
             .header-title { font-size: 11pt; } /* Levemente reduzido */
             .header-subtitle { font-size: 8.5pt; } /* Levemente reduzido */
             .data { font-size: 9.5pt; margin: 15px 0 10px;} /* Margem reduzida */
             .timbre { font-size: 9.5pt; margin-bottom: 10px; } /* Margem reduzida */
        }
    </style>
</head>
<body>
    <h1>Gerador de Documentos Jurídicos com Assinatura</h1>

    <div class="form-container" id="formulario">
        <div class="doc-selection">
            <h3>Selecione os documentos que deseja gerar:</h3>
            <div class="doc-options">
                <div class="doc-option" id="optContrato"><div class="doc-checkbox-wrapper"><input type="checkbox" class="doc-checkbox" id="checkContrato" onchange="atualizarSelecaoDocumento('contrato')"><h4>Contrato de Honorários</h4></div><p>Gera um contrato de honorários...</p></div>
                <div class="doc-option" id="optProcuracao"><div class="doc-checkbox-wrapper"><input type="checkbox" class="doc-checkbox" id="checkProcuracao" onchange="atualizarSelecaoDocumento('procuracao')"><h4>Procuração</h4></div><p>Gera uma procuração...</p></div>
                <div class="doc-option" id="optHipossuficiencia"><div class="doc-checkbox-wrapper"><input type="checkbox" class="doc-checkbox" id="checkHipossuficiencia" onchange="atualizarSelecaoDocumento('hipossuficiencia')"><h4>Declaração de Hipossuficiência</h4></div><p>Gera uma declaração...</p></div>
            </div>
        </div>
        <div class="tipo-pessoa">
            <label><input type="radio" name="tipoPessoa" value="fisica" checked onchange="togglePessoaJuridica()"> Pessoa Física</label>
            <label><input type="radio" name="tipoPessoa" value="juridica" onchange="togglePessoaJuridica()"> Pessoa Jurídica</label>
        </div>
        <div id="pessoaJuridicaFields">
             <h3 class="section-title">Dados da Empresa</h3>
             <div class="form-group"><label for="nomeEmpresa" class="required">Razão Social:</label><input type="text" id="nomeEmpresa"></div>
             <div class="form-group"><label for="cnpj" class="required">CNPJ:</label><input type="text" id="cnpj" placeholder="00.000.000/0001-00"></div>
             <div class="form-row">
                 <div class="form-col"><label for="tipoLogradouroEmpresa" class="required">Tipo Logradouro:</label><select id="tipoLogradouroEmpresa"><option value="Rua">Rua</option><option value="Avenida">Avenida</option><option value="Alameda">Alameda</option><option value="Estrada">Estrada</option><option value="Praça">Praça</option><option value="Travessa">Travessa</option><option value="Rodovia">Rodovia</option></select></div>
                 <div class="form-col"><label for="logradouroEmpresa" class="required">Logradouro:</label><input type="text" id="logradouroEmpresa"></div>
             </div>
             <div class="form-row">
                 <div class="form-col-small"><label for="numeroEmpresa" class="required">Número:</label><input type="text" id="numeroEmpresa"></div>
                 <div class="form-col"><label for="complementoEmpresa">Complemento:</label><input type="text" id="complementoEmpresa"></div>
             </div>
             <div class="form-row">
                 <div class="form-col"><label for="bairroEmpresa" class="required">Bairro:</label><input type="text" id="bairroEmpresa"></div>
                 <div class="form-col"><label for="cidadeEmpresa" class="required">Cidade:</label><input type="text" id="cidadeEmpresa"></div>
                 <div class="form-col-small"><label for="ufEmpresa" class="required">UF:</label><select id="ufEmpresa"><option value="AC">AC</option><option value="AL">AL</option><option value="AM">AM</option><option value="AP">AP</option><option value="BA">BA</option><option value="CE">CE</option><option value="DF">DF</option><option value="ES">ES</option><option value="GO">GO</option><option value="MA">MA</option><option value="MG">MG</option><option value="MS">MS</option><option value="MT">MT</option><option value="PA">PA</option><option value="PB">PB</option><option value="PE">PE</option><option value="PI">PI</option><option value="PR">PR</option><option value="RJ">RJ</option><option value="RN" selected>RN</option><option value="RO">RO</option><option value="RR">RR</option><option value="RS">RS</option><option value="SC">SC</option><option value="SE">SE</option><option value="SP">SP</option><option value="TO">TO</option></select></div>
             </div>
             <div class="form-group"><label for="cepEmpresa" class="required">CEP:</label><input type="text" id="cepEmpresa" placeholder="00000-000"></div>
        </div>
        <h3 class="section-title" id="dadosPessoaisTitle">Dados Pessoais</h3>
        <div class="form-group"><label for="nome" class="required">Nome completo:</label><input type="text" id="nome" required></div>
        <div class="form-row">
             <div class="form-col"><label for="nacionalidade" class="required">Nacionalidade:</label><input type="text" id="nacionalidade" value="brasileiro(a)" required></div>
             <div class="form-col"><label for="estadoCivil" class="required">Estado Civil:</label><select id="estadoCivil" required><option value="solteiro(a)">Solteiro(a)</option><option value="casado(a)">Casado(a)</option><option value="divorciado(a)">Divorciado(a)</option><option value="viúvo(a)">Viúvo(a)</option><option value="união estável">União Estável</option></select></div>
        </div>
        <div class="form-group"><label for="profissao" class="required">Profissão:</label><input type="text" id="profissao" required></div>
        <div class="form-row">
             <div class="form-col"><label for="rg" class="required">RG:</label><input type="text" id="rg" placeholder="Ex: 1234567 SSP/RN" required></div>
             <div class="form-col"><label for="cpf" class="required">CPF:</label><input type="text" id="cpf" placeholder="123.456.789-00" required></div>
        </div>
        <h3 class="section-title" id="enderecoTitle">Endereço</h3>
        <div class="form-row">
             <div class="form-col"><label for="tipoLogradouro" class="required">Tipo Logradouro:</label><select id="tipoLogradouro" required><option value="Rua">Rua</option><option value="Avenida">Avenida</option><option value="Alameda">Alameda</option><option value="Estrada">Estrada</option><option value="Praça">Praça</option><option value="Travessa">Travessa</option><option value="Rodovia">Rodovia</option></select></div>
             <div class="form-col"><label for="logradouro" class="required">Logradouro:</label><input type="text" id="logradouro" required></div>
        </div>
        <div class="form-row">
             <div class="form-col-small"><label for="numero" class="required">Número:</label><input type="text" id="numero" required></div>
             <div class="form-col"><label for="complemento">Complemento:</label><input type="text" id="complemento" placeholder="Apto, Bloco, etc."></div>
        </div>
        <div class="form-row">
             <div class="form-col"><label for="bairro" class="required">Bairro:</label><input type="text" id="bairro" required></div>
             <div class="form-col"><label for="cidade" class="required">Cidade:</label><input type="text" id="cidade" value="Parnamirim" required></div>
             <div class="form-col-small"><label for="uf" class="required">UF:</label><select id="uf" required><option value="AC">AC</option><option value="AL">AL</option><option value="AM">AM</option><option value="AP">AP</option><option value="BA">BA</option><option value="CE">CE</option><option value="DF">DF</option><option value="ES">ES</option><option value="GO">GO</option><option value="MA">MA</option><option value="MG">MG</option><option value="MS">MS</option><option value="MT">MT</option><option value="PA">PA</option><option value="PB">PB</option><option value="PE">PE</option><option value="PI">PI</option><option value="PR">PR</option><option value="RJ">RJ</option><option value="RN" selected>RN</option><option value="RO">RO</option><option value="RR">RR</option><option value="RS">RS</option><option value="SC">SC</option><option value="SE">SE</option><option value="SP">SP</option><option value="TO">TO</option></select></div>
        </div>
        <div class="form-group"><label for="cep" class="required">CEP:</label><input type="text" id="cep" placeholder="00000-000" required></div>

        <div id="contratoFields" class="documento-fields">
             <h3 class="section-title">Dados do Processo (Contrato)</h3>
             <div class="form-group"><label for="numeroProcesso" class="required">Nº Processo/Parte Adversa:</label><input type="text" id="numeroProcesso"></div>
             <h3 class="section-title">Condições de Pagamento</h3>
             <div class="form-group"><label for="valorTotal" class="required">Valor Total (R$):</label><input type="text" id="valorTotal" placeholder="R$ 0,00"></div>
             <div class="form-group"><label for="entradaDigital">Entrada (R$):</label><input type="text" id="entradaDigital" placeholder="R$ 0,00"></div>
             <div class="form-row">
                 <div class="form-col"><label for="numeroParcelas">Nº Parcelas (máx 10):</label><select id="numeroParcelas"><option value="0">Sem parcelamento</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option></select></div>
                 <div class="form-col-small"><label for="diaVencimento">Vencimento:</label><input type="number" id="diaVencimento" min="1" max="31" placeholder="Dia"></div>
             </div>
             <div class="form-group"><label for="percentualExito">Honorário Êxito (%):</label><input type="text" id="percentualExito" placeholder="Ex: 20"></div>
        </div>

        <div id="hipossuficienciaFields" class="documento-fields">
             <h3 class="section-title">Dados (Hipossuficiência)</h3>
             <div class="form-group"><label for="rendaMensal" class="required">Renda Mensal (R$):</label><input type="text" id="rendaMensal" placeholder="R$ 0,00"></div>
             <div class="form-group"><label for="numeroProcessoHipo">Nº Processo (opcional):</label><input type="text" id="numeroProcessoHipo" placeholder="Ex: 000..."></div>
             <div class="form-group"><label for="motivoHipossuficiencia" class="required">Justificativa:</label><textarea id="motivoHipossuficiencia" rows="3" placeholder="Descreva brevemente..."></textarea></div>
             <div class="form-group"><label>Documentos Comprobatórios:</label><div>
                 <label style="display: inline-flex; align-items: center; margin-right: 10px; font-weight: normal;"><input type="checkbox" id="docCadUnico" style="width: auto; margin-right: 5px;"> CadÚnico</label>
                 <label style="display: inline-flex; align-items: center; margin-right: 10px; font-weight: normal;"><input type="checkbox" id="docCTPS" style="width: auto; margin-right: 5px;"> CTPS/Holerite</label>
                 <label style="display: inline-flex; align-items: center; margin-right: 10px; font-weight: normal;"><input type="checkbox" id="docBPC" style="width: auto; margin-right: 5px;"> BPC/LOAS</label>
                 <label style="display: inline-flex; align-items: center; font-weight: normal;"><input type="checkbox" id="docDeclaracao" style="width: auto; margin-right: 5px;"> IR</label>
             </div></div>
        </div>

        <div class="form-group" style="margin-top: 25px; padding: 15px; background-color: #e8f0fe; border-radius: 5px;">
             <label style="display: inline-flex; align-items: center; font-weight: bold; color: #003366;">
                 <input type="checkbox" id="usarAssinaturaDesenho" style="width: auto; height: 18px; margin-right: 10px;">
                 Assinar documentos desenhando na tela? (Coleta dados de auditoria)
             </label>
        </div>
        <div class="buttons">
             <button id="btnGerarDocumentos" onclick="iniciarGeracaoDocumentos()">Gerar Documentos</button>
        </div>
    </div>

    <div id="documentosContainer" class="noPrint">
         <div class="buttons noPrint">
             <button onclick="voltarFormulario()" style="background-color: #666;">Voltar ao Formulário</button>
             <button onclick="window.print()" style="background-color: #007bff;">Imprimir Todos Documentos</button>
         </div>
         <div id="documentosGerados"></div>
    </div>

    <div id="assinaturaModal" class="noPrint">
         <div class="modal-content">
             <h3 style="text-align: center; margin-top: 0; color: #333;">Desenhe sua assinatura abaixo:</h3>
             <div class="signature-pad-container"><canvas id="signature-canvas"></canvas></div>
             <div class="modal-buttons">
                 <button type="button" id="confirmarAssinaturaBtn" style="background-color: #4CAF50;">Confirmar Assinatura e Gerar</button>
                 <button type="button" id="limparAssinaturaBtn" style="background-color: #ff9800;">Limpar</button>
                 <button type="button" id="cancelarAssinaturaBtn" style="background-color: #f44336;">Cancelar</button>
             </div>
         </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <script>
        let documentosSelecionados = [];
        let signaturePad = null;
        let assinaturaImagemData = null;
        let assinaturaAuditData = {};

        // --- Funções Utilitárias ---
        function atualizarSelecaoDocumento(tipo) {
            const checkbox = document.getElementById(`check${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`);
            const docOption = document.getElementById(`opt${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`);
            if (checkbox.checked) {
                docOption.classList.add('selected');
                if (!documentosSelecionados.includes(tipo)) documentosSelecionados.push(tipo);
            } else {
                docOption.classList.remove('selected');
                documentosSelecionados = documentosSelecionados.filter(doc => doc !== tipo);
            }
            atualizarCamposEspecificos();
            atualizarTextoBotao();
        }
        function atualizarCamposEspecificos() {
            document.querySelectorAll('.documento-fields').forEach(f => f.style.display = 'none');
            if (documentosSelecionados.includes('contrato')) document.getElementById('contratoFields').style.display = 'block';
            if (documentosSelecionados.includes('hipossuficiencia')) document.getElementById('hipossuficienciaFields').style.display = 'block';
        }
        function atualizarTextoBotao() {
            const btn = document.getElementById('btnGerarDocumentos');
            btn.disabled = documentosSelecionados.length === 0;
            btn.textContent = documentosSelecionados.length === 0 ? 'Selecione um documento' : `Gerar ${documentosSelecionados.length} Documento(s)`;
        }
        function togglePessoaJuridica() {
            const tipo = document.querySelector('input[name="tipoPessoa"]:checked').value;
            const fieldsPJ = document.getElementById('pessoaJuridicaFields');
            document.getElementById('documentosContainer').style.display = 'none';
            document.getElementById('formulario').style.display = 'block';
            fieldsPJ.style.display = tipo === 'juridica' ? 'block' : 'none';
            document.getElementById('dadosPessoaisTitle').textContent = tipo === 'juridica' ? 'Dados do Representante' : 'Dados Pessoais';
            document.getElementById('enderecoTitle').textContent = tipo === 'juridica' ? 'Endereço do Representante' : 'Endereço';
        }
        function formatarData(data) {
            return `${data.getDate().toString().padStart(2, '0')} de ${data.toLocaleString('pt-BR', { month: 'long' })} de ${data.getFullYear()}`;
        }
        function formatarValor(valor) {
             if (typeof valor === 'number') return valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
             const valorNumerico = parseMoeda(valor);
             return valorNumerico.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }
        function parseMoeda(valor) {
            if (typeof valor === 'number') return valor;
            if (!valor || typeof valor !== 'string') return 0;
            const valorLimpo = valor.replace(/R\$\s?/, '').replace(/\./g, '').replace(',', '.');
            const numero = parseFloat(valorLimpo);
            return isNaN(numero) ? 0 : numero;
        }
        function calcularValorParcela(valorTotal, entrada, numParcelas) {
            if (numParcelas <= 0) return 0;
            const valorParcelar = parseMoeda(valorTotal) - parseMoeda(entrada);
            return valorParcelar / parseInt(numParcelas);
        }
        function voltarFormulario() {
            document.getElementById('documentosContainer').style.display = 'none';
            document.getElementById('formulario').style.display = 'block';
            document.getElementById('formulario').scrollIntoView({ behavior: 'smooth' });
        }

        // --- Funções de Assinatura e Auditoria ---
       async function getIpAndLocation() {
    try {
        // Primeiro obter apenas o IP usando ipify (melhor suporte CORS)
        const ipResponse = await fetch('https://api.ipify.org?format=json');
        if (!ipResponse.ok) throw new Error(`HTTP error! status: ${ipResponse.status}`);
        const ipData = await ipResponse.json();
        const userIp = ipData.ip || 'N/A';
        
        // Depois tentar obter a localização usando o IP obtido
        const geoResponse = await fetch(`https://ipapi.co/${userIp}/json/`);
        if (!geoResponse.ok) throw new Error(`HTTP error! status: ${geoResponse.status}`);
        const geoData = await geoResponse.json();
        
        let locationString = [geoData.city, geoData.region, geoData.country_name].filter(Boolean).join(', ');
        return { ip: userIp, location: locationString || 'N/A' };
    } catch (error) {
        console.error("Erro ao obter IP/Local (API):", error);
        return { ip: 'Erro ao obter', location: 'Erro ao obter' };
    }
}
        function getBrowserGeolocation() {
            return new Promise((resolve) => {
                if (!('geolocation' in navigator)) {
                    resolve({ latitude: 'N/A', longitude: 'N/A', accuracy: 'N/A', error: 'Não suportado' }); return;
                }
                navigator.geolocation.getCurrentPosition(
                    (pos) => resolve({ latitude: pos.coords.latitude.toFixed(5), longitude: pos.coords.longitude.toFixed(5), accuracy: pos.coords.accuracy.toFixed(0), error: null }),
                    (err) => resolve({ latitude: 'N/A', longitude: 'N/A', accuracy: 'N/A', error: err.message }),
                    { enableHighAccuracy: false, timeout: 8000, maximumAge: 60000 }
                );
            });
        }
        function mostrarModalAssinatura() {
            const modal = document.getElementById('assinaturaModal');
            const canvas = document.getElementById('signature-canvas');
            const container = canvas.parentNode;
            canvas.width = container.offsetWidth;
            canvas.height = container.offsetHeight;
            if (!signaturePad) {
                signaturePad = new SignaturePad(canvas, { backgroundColor: 'rgb(255, 255, 255)', penColor: 'rgb(0, 0, 0)' });
            } else {
                signaturePad.clear();
            }
            modal.style.display = 'flex';
            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();
        }
        function esconderModalAssinatura() {
            document.getElementById('assinaturaModal').style.display = 'none';
            window.removeEventListener('resize', resizeCanvas);
        }
        function resizeCanvas() {
           if (!signaturePad) return;
           const canvas = document.getElementById('signature-canvas');
           const container = canvas.parentNode;
           const ratio = Math.max(window.devicePixelRatio || 1, 1);
           canvas.width = container.offsetWidth * ratio;
           canvas.height = container.offsetHeight * ratio;
           canvas.getContext("2d").scale(ratio, ratio);
           signaturePad.clear();
        }
        function gerarAuditTrailHtml(auditData) {
            if (!auditData || Object.keys(auditData).length === 0) return '';
            let geoString = '';
            if (auditData.latitude !== 'N/A') {
                geoString = ` | Geo: ${auditData.latitude}, ${auditData.longitude} (±${auditData.accuracy}m)`;
            } else if (auditData.locationError && auditData.locationError !== 'Não suportado') {
                 geoString = ` | Geo Error: ${auditData.locationError}`;
            }
            const userAgentShort = auditData.userAgent ? auditData.userAgent.substring(0, 60) + '...' : 'N/A';
            return `
                <div class="audit-trail">
                    Assinado em: ${auditData.timestamp || 'N/A'} | IP: ${auditData.ip || 'N/A'} | Local (API): ${auditData.locationApi || 'N/A'}${geoString}<br>
                    Dispositivo: ${userAgentShort}
                </div>`;
        }

        // --- Lógica de Geração Principal ---
        function iniciarGeracaoDocumentos() {
            if (documentosSelecionados.length === 0) { alert('Selecione pelo menos um documento.'); return; }
            document.getElementById('documentosGerados').innerHTML = '';
            if (!verificarCamposObrigatoriosComuns()) return;
            let camposEspecificosValidos = true;
            if (documentosSelecionados.includes('contrato') && !verificarCamposContrato()) camposEspecificosValidos = false;
            if (documentosSelecionados.includes('hipossuficiencia') && !verificarCamposHipossuficiencia()) camposEspecificosValidos = false;
            if (!camposEspecificosValidos) return;
            if (document.getElementById('usarAssinaturaDesenho').checked) {
                mostrarModalAssinatura();
            } else {
                processarAssinaturaEGerarDocs(null, null);
            }
        }
        async function confirmarEProcessarAssinatura() {
            if (!signaturePad || signaturePad.isEmpty()) { alert("Desenhe sua assinatura."); return; }
            assinaturaImagemData = signaturePad.toDataURL('image/png');
            alert("Coletando dados de auditoria... Aguarde.");
            try {
                const timestamp = new Date();
                const [ipLocationData, browserLocationData] = await Promise.all([getIpAndLocation(), getBrowserGeolocation()]);
                assinaturaAuditData = {
                    timestamp: timestamp.toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'medium', hour12: false }),
                    ip: ipLocationData.ip, locationApi: ipLocationData.location, userAgent: navigator.userAgent,
                    latitude: browserLocationData.latitude, longitude: browserLocationData.longitude,
                    accuracy: browserLocationData.accuracy, locationError: browserLocationData.error
                };
                esconderModalAssinatura();
                processarAssinaturaEGerarDocs(assinaturaImagemData, assinaturaAuditData);
            } catch (error) {
                console.error("Erro ao coletar dados de auditoria:", error);
                alert("Erro ao coletar dados. Tente novamente.");
                assinaturaImagemData = null; assinaturaAuditData = {};
            }
        }
        function processarAssinaturaEGerarDocs(signatureData, auditData) {
            if (documentosSelecionados.includes('procuracao')) gerarProcuracao(signatureData, auditData);
            if (documentosSelecionados.includes('hipossuficiencia')) gerarDeclaracaoHipossuficiencia(signatureData, auditData);
            if (documentosSelecionados.includes('contrato')) gerarContrato(signatureData, auditData);
            document.getElementById('documentosContainer').style.display = 'block';
            document.getElementById('formulario').style.display = 'none';
            document.getElementById('documentosContainer').scrollIntoView({ behavior: 'smooth' });
            assinaturaImagemData = null; assinaturaAuditData = {};
            signaturePad?.clear();
        }

        // --- Funções de Validação ---
        function verificarCamposObrigatoriosComuns() {
            const tipoPessoa = document.querySelector('input[name="tipoPessoa"]:checked').value;
            const campos = [
                { id: 'nome', label: 'Nome' }, { id: 'nacionalidade', label: 'Nacionalidade' },
                { id: 'profissao', label: 'Profissão' }, { id: 'rg', label: 'RG' }, { id: 'cpf', label: 'CPF' },
                { id: 'logradouro', label: 'Logradouro' }, { id: 'numero', label: 'Número' },
                { id: 'bairro', label: 'Bairro' }, { id: 'cidade', label: 'Cidade' }, { id: 'cep', label: 'CEP' } ];
            if (tipoPessoa === 'juridica') {
                campos.push( { id: 'nomeEmpresa', label: 'Razão Social' }, { id: 'cnpj', label: 'CNPJ' },
                    { id: 'logradouroEmpresa', label: 'Logradouro Empresa' }, { id: 'numeroEmpresa', label: 'Número Empresa' },
                    { id: 'bairroEmpresa', label: 'Bairro Empresa' }, { id: 'cidadeEmpresa', label: 'Cidade Empresa' },
                    { id: 'cepEmpresa', label: 'CEP Empresa' } );
            }
            const faltantes = campos.filter(c => !document.getElementById(c.id)?.value?.trim()).map(c => c.label);
            if (faltantes.length > 0) { alert('Campos obrigatórios faltando:\n- ' + faltantes.join('\n- ')); return false; }
            return true;
        }
        function verificarCamposContrato() {
            const campos = [{ id: 'numeroProcesso', label: 'Nº Processo/Parte Adversa' }, { id: 'valorTotal', label: 'Valor Total' }];
            const faltantes = campos.filter(c => !document.getElementById(c.id)?.value?.trim()).map(c => c.label);
            if (faltantes.length > 0) { alert('Campos do Contrato faltando:\n- ' + faltantes.join('\n- ')); return false; }
            return true;
        }
        function verificarCamposHipossuficiencia() {
            const campos = [{ id: 'rendaMensal', label: 'Renda Mensal' }, { id: 'motivoHipossuficiencia', label: 'Justificativa' }];
            const faltantes = campos.filter(c => !document.getElementById(c.id)?.value?.trim()).map(c => c.label);
            if (faltantes.length > 0) { alert('Campos da Hipossuficiência faltando:\n- ' + faltantes.join('\n- ')); return false; }
            return true;
        }

        // --- Funções de Geração de Documentos ---
        // (O conteúdo interno destas funções é igual ao da resposta anterior,
        // apenas garantindo que chamam gerarAuditTrailHtml e incluem o resultado)
        function gerarContrato(signatureData, auditData) {
             const tipoPessoa = document.querySelector('input[name="tipoPessoa"]:checked').value;
             const nome = document.getElementById('nome').value;
             const cpf = document.getElementById('cpf').value;
             const nacionalidade = document.getElementById('nacionalidade').value;
             const estadoCivil = document.getElementById('estadoCivil').value;
             const profissao = document.getElementById('profissao').value;
             const rg = document.getElementById('rg').value;
             const tipoLogradouro = document.getElementById('tipoLogradouro').value;
             const logradouro = document.getElementById('logradouro').value;
             const numero = document.getElementById('numero').value;
             const complemento = document.getElementById('complemento').value;
             const bairro = document.getElementById('bairro').value;
             const cidade = document.getElementById('cidade').value;
             const uf = document.getElementById('uf').value;
             const cep = document.getElementById('cep').value;
             const numeroProcesso = document.getElementById('numeroProcesso').value;
             const valorTotal = document.getElementById('valorTotal').value;
             const entradaDigital = document.getElementById('entradaDigital').value;
             const numeroParcelas = document.getElementById('numeroParcelas').value;
             const diaVencimento = document.getElementById('diaVencimento').value;
             const percentualExito = document.getElementById('percentualExito').value;

             let enderecoCompleto = `${tipoLogradouro} ${logradouro}, ${numero}${complemento ? ', ' + complemento : ''}, ${bairro}, ${cidade}/${uf}, CEP: ${cep}`;
             let dadosEmpresaHtml = '';
             if (tipoPessoa === 'juridica') {
                 const nomeEmpresa = document.getElementById('nomeEmpresa').value;
                 const cnpj = document.getElementById('cnpj').value;
                 const tipoLogradouroEmpresa = document.getElementById('tipoLogradouroEmpresa').value;
                 const logradouroEmpresa = document.getElementById('logradouroEmpresa').value;
                 const numeroEmpresa = document.getElementById('numeroEmpresa').value;
                 const complementoEmpresa = document.getElementById('complementoEmpresa').value;
                 const bairroEmpresa = document.getElementById('bairroEmpresa').value;
                 const cidadeEmpresa = document.getElementById('cidadeEmpresa').value;
                 const ufEmpresa = document.getElementById('ufEmpresa').value;
                 const cepEmpresa = document.getElementById('cepEmpresa').value;
                 let enderecoEmpresa = `${tipoLogradouroEmpresa} ${logradouroEmpresa}, ${numeroEmpresa}${complementoEmpresa ? ', ' + complementoEmpresa : ''}, ${bairroEmpresa}, ${cidadeEmpresa}/${ufEmpresa}, CEP: ${cepEmpresa}`;
                 dadosEmpresaHtml = `<p>CONTRATANTE: <strong>${nomeEmpresa}</strong>, pessoa jurídica de direito privado, inscrita no CNPJ sob o nº ${cnpj}, com sede em ${enderecoEmpresa}, representado(a) neste ato por <strong>${nome}</strong>, ${nacionalidade}, ${estadoCivil}, ${profissao}, portador(a) do RG nº ${rg}, inscrito(a) no CPF sob o nº ${cpf}, residente e domiciliado(a) em ${enderecoCompleto}.</p>`;
             } else {
                 dadosEmpresaHtml = `<p>CONTRATANTE: <strong>${nome}</strong>, ${nacionalidade}, ${estadoCivil}, ${profissao}, portador(a) do RG nº ${rg}, inscrito(a) no CPF sob o nº ${cpf}, residente e domiciliado(a) em ${enderecoCompleto}.</p>`;
             }

             const valorTotalFormatado = formatarValor(valorTotal);
             let textoEntrada = entradaDigital && parseMoeda(entradaDigital) > 0 ? `<li>Entrada no valor de ${formatarValor(entradaDigital)}, a ser paga no ato da assinatura deste contrato.</li>` : "";
             let textoParcelamento = "";
             if (numeroParcelas && parseInt(numeroParcelas) > 0) {
                 const valorParcela = calcularValorParcela(valorTotal, entradaDigital, numeroParcelas);
                 textoParcelamento = `<li>${numeroParcelas} parcela(s) no valor de ${formatarValor(valorParcela)} cada, com vencimento todo dia ${diaVencimento || '05'} de cada mês.</li>`;
             }
             let textoPercentual = percentualExito && parseFloat(percentualExito) > 0 ? `<li>Adicionalmente, será devido o percentual de ${percentualExito}% (${percentualExito} por cento) sobre o proveito econômico final obtido no processo, a ser pago em até 5 (cinco) dias úteis após o recebimento pelo CONTRATANTE.</li>` : "";
             const dataAtual = formatarData(new Date());

             let assinaturaHtml = signatureData ? `<img src="${signatureData}" alt="Assinatura Digital">` : `<span class="linha"></span>`;
             assinaturaHtml += `<p>${nome}<br>CPF: ${cpf}<br>CONTRATANTE</p>`;
             const auditTrailHtml = gerarAuditTrailHtml(auditData);

             let contratoHtmlCompleto = `
                 <div class="documento-preview" id="contrato-documento">
                     <div class="doc-title noPrint"><h3>Contrato de Honorários</h3><div class="doc-buttons"><button onclick="imprimirDocumentoEspecifico('contrato-documento')">Imprimir</button></div></div>
                     <div class="documento">
                         <div class="header-container"><div class="header-title">MEDEIROS E ALBUQUERQUE ADVOCACIA</div><div class="header-subtitle">www.medeirosealbuquerqueadv.com.br</div></div>
                         <h2>CONTRATO DE HONORÁRIOS ADVOCATÍCIOS</h2>
                         ${dadosEmpresaHtml}
                         <p>CONTRATADO: <strong>JOÃO PAULO SILVA DE MEDEIROS</strong>, OAB/RN 15.441</p>
                         <h2>DO OBJETO DO CONTRATO</h2>
                         <p><strong>Cláusula 1ª.</strong> Prestação de serviços advocatícios no processo nº/Requerido ${numeroProcesso}.</p>
                         <h2>DOS DEVERES E OBRIGAÇÕES DO CONTRATADO</h2>
                         <p><strong>Cláusula 2ª.</strong> Atuar com zelo e profissionalismo, utilizando todos os meios legais.</p>
                         <p><strong>Cláusula 3ª.</strong> Informar o Contratante sobre o andamento do processo e solicitar documentos necessários.</p>
                         <p><strong>Cláusula 4ª.</strong> Cumprir as normas éticas da OAB.</p>
                         <h2>DOS DEVERES E OBRIGAÇÕES DO CONTRATANTE</h2>
                         <p><strong>Cláusula 5ª.</strong> Fornecer documentos e informações solicitadas.</p>
                         <p><strong>Cláusula 6ª.</strong> Comparecer a atos processuais e compromissos agendados.</p>
                         <h2>DOS HONORÁRIOS ADVOCATÍCIOS</h2>
                         <p><strong>Cláusula 7ª.</strong> Total: ${valorTotalFormatado}, a serem pagos:</p>
                         <ul>${textoEntrada}${textoParcelamento}${textoPercentual}</ul>
                         <p><strong>Cláusula 8ª.</strong> Dados bancários:</p>
                         <p>Banco: INTER (077), Agência: 0001, Conta: 28556993-7, Titular: JOAO PAULO SILVA DE MEDEIROS SOCIEDADE INDIVIDUAL DE ADVOCACIA, CNPJ/PIX: 50.305.249/0001-83</p>
                         <p><strong>Cláusula 9ª.</strong> Multa por atraso: 2% + 1% ao mês (pro rata die).</p>
                         <h2>DA RESCISÃO DO CONTRATO</h2>
                         <p><strong>Cláusula 10ª.</strong> Rescisão com notificação prévia de 10 dias:</p>
                         <p>Contratante: Pagamento integral dos honorários.</p>
                         <p>Contratado: Honorários proporcionais aos serviços prestados.</p>
                         <div class="data">Natal/RN, ${dataAtual}.</div>
                         <div class="assinatura">
                             ${assinaturaHtml}
                             ${auditTrailHtml}
                         </div>
                     </div>
                 </div>`;
             document.getElementById('documentosGerados').innerHTML += contratoHtmlCompleto;
        }
        function gerarProcuracao(signatureData, auditData) {
            const tipoPessoa = document.querySelector('input[name="tipoPessoa"]:checked').value;
            const nome = document.getElementById('nome').value;
            const cpf = document.getElementById('cpf').value;
            const nacionalidade = document.getElementById('nacionalidade').value;
            const estadoCivil = document.getElementById('estadoCivil').value;
            const profissao = document.getElementById('profissao').value;
            const rg = document.getElementById('rg').value;
            const tipoLogradouro = document.getElementById('tipoLogradouro').value;
            const logradouro = document.getElementById('logradouro').value;
            const numero = document.getElementById('numero').value;
            const complemento = document.getElementById('complemento').value;
            const bairro = document.getElementById('bairro').value;
            const cidade = document.getElementById('cidade').value;
            const uf = document.getElementById('uf').value;
            const cep = document.getElementById('cep').value;

            let enderecoCompleto = `${tipoLogradouro} ${logradouro}, ${numero}${complemento ? ', ' + complemento : ''}, ${bairro}, ${cidade}/${uf}, CEP: ${cep}`;
            let dadosOutorganteHtml = '';
            if (tipoPessoa === 'juridica') {
                 const nomeEmpresa = document.getElementById('nomeEmpresa').value;
                 const cnpj = document.getElementById('cnpj').value;
                 const tipoLogradouroEmpresa = document.getElementById('tipoLogradouroEmpresa').value;
                 const logradouroEmpresa = document.getElementById('logradouroEmpresa').value;
                 const numeroEmpresa = document.getElementById('numeroEmpresa').value;
                 const complementoEmpresa = document.getElementById('complementoEmpresa').value;
                 const bairroEmpresa = document.getElementById('bairroEmpresa').value;
                 const cidadeEmpresa = document.getElementById('cidadeEmpresa').value;
                 const ufEmpresa = document.getElementById('ufEmpresa').value;
                 const cepEmpresa = document.getElementById('cepEmpresa').value;
                 let enderecoEmpresa = `${tipoLogradouroEmpresa} ${logradouroEmpresa}, ${numeroEmpresa}${complementoEmpresa ? ', ' + complementoEmpresa : ''}, ${bairroEmpresa}, ${cidadeEmpresa}/${ufEmpresa}, CEP: ${cepEmpresa}`;
                 dadosOutorganteHtml = `<p>OUTORGANTE: <strong>${nomeEmpresa}</strong>, pessoa jurídica de direito privado, inscrita no CNPJ sob o nº ${cnpj}, com sede em ${enderecoEmpresa}, representado(a) neste ato por <strong>${nome}</strong>, ${nacionalidade}, ${estadoCivil}, ${profissao}, portador(a) do RG nº ${rg}, inscrito(a) no CPF sob o nº ${cpf}, residente e domiciliado(a) em ${enderecoCompleto}.</p>`;
            } else {
                 dadosOutorganteHtml = `<p>OUTORGANTE: <strong>${nome}</strong>, ${nacionalidade}, ${estadoCivil}, ${profissao}, portador(a) do RG nº ${rg}, inscrito(a) no CPF sob o nº ${cpf}, residente e domiciliado(a) em ${enderecoCompleto}.</p>`;
            }
            const dataAtual = formatarData(new Date());

            let assinaturaHtml = signatureData ? `<img src="${signatureData}" alt="Assinatura Digital">` : `<span class="linha"></span>`;
            assinaturaHtml += `<p>${nome}<br>CPF: ${cpf}</p>`;
            const auditTrailHtml = gerarAuditTrailHtml(auditData);

            let procuracaoHtmlCompleto = `
                 <div class="documento-preview" id="procuracao-documento">
                     <div class="doc-title noPrint"><h3>Procuração Judicial</h3><div class="doc-buttons"><button onclick="imprimirDocumentoEspecifico('procuracao-documento')">Imprimir</button></div></div>
                     <div class="documento">
                         <div class="header-container"><div class="header-title">MEDEIROS E ALBUQUERQUE ADVOCACIA</div><div class="header-subtitle">www.medeirosealbuquerqueadv.com.br</div></div>
                         <div class="timbre">INSTRUMENTO PARTICULAR DE PROCURAÇÃO</div>
                         <h2>PROCURAÇÃO "AD JUDICIA ET EXTRA"</h2>
                         ${dadosOutorganteHtml}
                         <p>OUTORGADOS:</p>
                         <p>1. <strong>JOÃO PAULO S. MEDEIROS</strong>, advogado, inscrito na Ordem dos Advogados do Brasil, Seccional do Rio Grande do Norte, sob o nº 15.441.</p>
                         <p>2. <strong>ALANE MEDEIROS DE ALBUQUERQUE</strong>, advogada, inscrita na Ordem dos Advogados do Brasil, Seccional do Rio Grande do Norte, sob o nº 14.994.</p>
                         <p>Por este instrumento particular de procuração, o(a) outorgante acima qualificado(a) nomeia e constitui como seus bastantes procuradores os outorgados acima mencionados, a quem confere amplos poderes para o foro em geral, com a cláusula "ad judicia et extra", em qualquer Juízo, Instância ou Tribunal, podendo propor contra quem de direito as ações competentes e defendê-lo(a) nas contrárias, seguindo umas e outras, até final decisão, usando os recursos legais e acompanhando-os, conferindo-lhes, ainda, poderes especiais para:</p>
                         <p>Confessar, desistir, transigir, firmar compromissos ou acordos, receber e dar quitação, levantar FGTS e seguro desemprego, receber e dar quitação, levantar alvarás judiciais, agindo em conjunto ou separadamente, podendo ainda substabelecer esta em outrem, com ou sem reservas de iguais poderes, dando tudo por bom, firme e valioso, especialmente para representação em processo judicial.</p>
                         <div class="data">${cidade}/${uf}, ${dataAtual}.</div>
                         <div class="assinatura">
                             ${assinaturaHtml}
                             ${auditTrailHtml}
                         </div>
                     </div>
                 </div>`;
            document.getElementById('documentosGerados').innerHTML += procuracaoHtmlCompleto;
        }
        function gerarDeclaracaoHipossuficiencia(signatureData, auditData) {
             const tipoPessoa = document.querySelector('input[name="tipoPessoa"]:checked').value;
             const nome = document.getElementById('nome').value;
             const cpf = document.getElementById('cpf').value;
             const nacionalidade = document.getElementById('nacionalidade').value;
             const estadoCivil = document.getElementById('estadoCivil').value;
             const profissao = document.getElementById('profissao').value;
             const rg = document.getElementById('rg').value;
             const tipoLogradouro = document.getElementById('tipoLogradouro').value;
             const logradouro = document.getElementById('logradouro').value;
             const numero = document.getElementById('numero').value;
             const complemento = document.getElementById('complemento').value;
             const bairro = document.getElementById('bairro').value;
             const cidade = document.getElementById('cidade').value;
             const uf = document.getElementById('uf').value;
             const cep = document.getElementById('cep').value;
             const rendaMensal = document.getElementById('rendaMensal').value;
             const numeroProcessoHipo = document.getElementById('numeroProcessoHipo').value;
             const motivoHipossuficiencia = document.getElementById('motivoHipossuficiencia').value;
             const docCadUnico = document.getElementById('docCadUnico').checked;
             const docCTPS = document.getElementById('docCTPS').checked;
             const docBPC = document.getElementById('docBPC').checked;
             const docDeclaracao = document.getElementById('docDeclaracao').checked;

             let enderecoCompleto = `${tipoLogradouro} ${logradouro}, ${numero}${complemento ? ', ' + complemento : ''}, ${bairro}, ${cidade}/${uf}, CEP: ${cep}`;
             let declaranteHtml = '';
             if (tipoPessoa === 'juridica') {
                 const nomeEmpresa = document.getElementById('nomeEmpresa').value;
                 const cnpj = document.getElementById('cnpj').value;
                 const tipoLogradouroEmpresa = document.getElementById('tipoLogradouroEmpresa').value;
                 const logradouroEmpresa = document.getElementById('logradouroEmpresa').value;
                 const numeroEmpresa = document.getElementById('numeroEmpresa').value;
                 const complementoEmpresa = document.getElementById('complementoEmpresa').value;
                 const bairroEmpresa = document.getElementById('bairroEmpresa').value;
                 const cidadeEmpresa = document.getElementById('cidadeEmpresa').value;
                 const ufEmpresa = document.getElementById('ufEmpresa').value;
                 const cepEmpresa = document.getElementById('cepEmpresa').value;
                 let enderecoEmpresa = `${tipoLogradouroEmpresa} ${logradouroEmpresa}, ${numeroEmpresa}${complementoEmpresa ? ', ' + complementoEmpresa : ''}, ${bairroEmpresa}, ${cidadeEmpresa}/${ufEmpresa}, CEP: ${cepEmpresa}`;
                 declaranteHtml = `<p>A empresa <strong>${nomeEmpresa}</strong>, pessoa jurídica de direito privado, inscrita no CNPJ sob o nº ${cnpj}, com sede em ${enderecoEmpresa}, representada neste ato por <strong>${nome}</strong>, ${nacionalidade}, ${estadoCivil}, ${profissao}, portador(a) do RG nº ${rg}, inscrito(a) no CPF sob o nº ${cpf}, residente e domiciliado(a) em ${enderecoCompleto}, DECLARA, sob as penas da lei, para fins de comprovação junto ao Poder Judiciário, que é hipossuficiente financeiramente, sendo impossibilitada de arcar com as despesas processuais e os honorários advocatícios sem prejuízo de sua atividade.</p>`;
             } else {
                 declaranteHtml = `<p>Eu, <strong>${nome}</strong>, ${nacionalidade}, ${estadoCivil}, ${profissao}, portador(a) do RG nº ${rg}, inscrito(a) no CPF sob o nº ${cpf}, residente e domiciliado(a) em ${enderecoCompleto}, DECLARO, sob as penas da lei, para fins de comprovação junto ao Poder Judiciário, que sou hipossuficiente financeiramente, sendo impossibilitado(a) de arcar com as despesas processuais e os honorários advocatícios sem prejuízo do sustento próprio e de minha família.</p>`;
             }
             const dataAtual = formatarData(new Date());
             const rendaMensalFormatada = formatarValor(rendaMensal);
             let listaDocs = [ docCadUnico ? "Cadastro Único" : null, docCTPS ? "CTPS/Holerite" : null, docBPC ? "BPC/LOAS" : null, docDeclaracao ? "Declaração de IR" : null ].filter(Boolean);
             let textoDocs = listaDocs.length > 0 ? `<p>Para comprovar: ${listaDocs.join(', ')}.</p>` : "";

             let assinaturaHtml = signatureData ? `<img src="${signatureData}" alt="Assinatura Digital">` : `<span class="linha"></span>`;
             assinaturaHtml += `<p>${nome}<br>CPF: ${cpf}</p>`;
             const auditTrailHtml = gerarAuditTrailHtml(auditData);

              let declaracaoHtmlCompleta = `
                 <div class="documento-preview" id="hipossuficiencia-documento">
                     <div class="doc-title noPrint"><h3>Declaração de Hipossuficiência</h3><div class="doc-buttons"><button onclick="imprimirDocumentoEspecifico('hipossuficiencia-documento')">Imprimir</button></div></div>
                     <div class="documento">
                         <div class="header-container"><div class="header-title">MEDEIROS E ALBUQUERQUE ADVOCACIA</div><div class="header-subtitle">www.medeirosealbuquerqueadv.com.br</div></div>
                         <h2>DECLARAÇÃO DE HIPOSSUFICIÊNCIA FINANCEIRA</h2>
                         ${declaranteHtml}
                         <p>Declaro que possuo renda mensal aproximada de ${rendaMensalFormatada}.</p>
                         <p>Informo ainda que a minha situação econômico-financeira não me permite pagar as custas do processo e os honorários de advogado, sem prejuízo do sustento próprio ou da família, pelos seguintes motivos:</p>
                         <p>${motivoHipossuficiencia}</p>
                         ${numeroProcessoHipo ? `<p>Esta declaração é feita para fins de instrução do processo nº ${numeroProcessoHipo}.</p>` : ''}
                         ${textoDocs}
                         <p>Declaro estar ciente de que a falsidade da presente declaração pode implicar em sanção penal prevista no art. 299 do Código Penal (falsidade ideológica), além de, caso comprovada a não veracidade, ser solicitado o cancelamento da gratuidade, conforme disposto no § 2º do art. 99 do Código de Processo Civil.</p>
                         <div class="data">${cidade}/${uf}, ${dataAtual}.</div>
                         <div class="assinatura">
                             ${assinaturaHtml}
                             ${auditTrailHtml}
                         </div>
                     </div>
                 </div>`;
             document.getElementById('documentosGerados').innerHTML += declaracaoHtmlCompleta;
        }

        // --- Função de Impressão Específica ---
        function imprimirDocumentoEspecifico(docId) {
             const docElement = document.getElementById(docId);
             const conteudoDoc = docElement.querySelector('.documento').cloneNode(true);
             let titulo = docElement.querySelector('.doc-title h3')?.textContent || "Documento";
             titulo += " - " + document.getElementById('nome').value;
             const printWindow = window.open('', '_blank', 'height=700,width=850');
             printWindow.document.write('<html><head><title>' + titulo + '</title>');
             printWindow.document.write('<style>');
             printWindow.document.write(`
                 /* Estilos de Impressão Otimizados */
                 @page { size: A4; margin: 18mm 15mm 15mm 15mm; }
                 body { font-family: 'Times New Roman', Times, serif; margin: 0; padding: 0; font-size: 9.5pt; line-height: 1.15;}
                 .documento { font-size: 9.5pt; line-height: 1.15; text-align: justify; }
                 .documento h2 { text-align: center; font-size: 9.5pt; margin: 10px 0 6px; font-weight: bold; }
                 .assinatura { margin-top: 20mm; text-align: center; page-break-inside: avoid !important; }
                 .assinatura img { display: block; margin: 5px auto 0; max-width: 160px; height: auto; border-bottom: 1px solid black; padding-bottom: 2px;}
                 .assinatura p { font-size: 8.5pt; margin-top: 1px; }
                 .audit-trail { font-size: 6.5pt; color: #444; margin-top: 3px; line-height: 1.0; text-align: center; font-family: Arial, sans-serif; page-break-inside: avoid; word-wrap: break-word;}
                 .data { text-align: right; margin: 15px 0 10px; font-size: 9.5pt;}
                 .timbre { text-align: center; margin-bottom: 10px; font-size: 9.5pt; color: #555; }
                 .documento p { margin: 0.3em 0; orphans: 3; widows: 3; }
                 .documento ul { padding-left: 18px; margin: 4px 0; } .documento ul li { margin: 1px 0; }
                 .header-container { text-align: center; margin-bottom: 10px; }
                 .header-title { font-size: 11pt; font-weight: bold; color: #003366; margin-bottom: 4px; }
                 .header-subtitle { font-size: 8.5pt; color: #666; }
                 .linha { display: block; width: 70%; border-bottom: 1px solid black; margin: 0 auto 5px auto; height: 1px; }
                 .assinatura img + .linha { display: none; }
             `);
             printWindow.document.write('</style></head><body>');
             printWindow.document.write(conteudoDoc.outerHTML);
             printWindow.document.write('</body></html>');
             printWindow.document.close();
             printWindow.focus();
             setTimeout(() => { printWindow.print(); }, 500);
        }

        // --- Inicialização e Máscaras ---
        document.addEventListener('DOMContentLoaded', function() {
            // Listeners botões do modal
            document.getElementById('limparAssinaturaBtn').addEventListener('click', () => signaturePad?.clear());
            document.getElementById('cancelarAssinaturaBtn').addEventListener('click', esconderModalAssinatura);
            document.getElementById('confirmarAssinaturaBtn').addEventListener('click', confirmarEProcessarAssinatura);

            // Máscaras (CPF, CNPJ, CEP, Valor)
             document.getElementById('cpf').addEventListener('input', function(e) {let v=e.target.value.replace(/\D/g,'').substring(0,11);v=v.replace(/(\d{3})(\d)/,'$1.$2');v=v.replace(/(\d{3})(\d)/,'$1.$2');v=v.replace(/(\d{3})(\d{1,2})$/,'$1-$2');e.target.value=v;});
             document.getElementById('cnpj').addEventListener('input', function(e){let v=e.target.value.replace(/\D/g,'').substring(0,14);v=v.replace(/^(\d{2})(\d)/,'$1.$2');v=v.replace(/^(\d{2})\.(\d{3})(\d)/,'$1.$2.$3');v=v.replace(/\.(\d{3})(\d)/,'.$1/$2');v=v.replace(/(\d{4})(\d)/,'$1-$2');e.target.value=v;});
             const mascaraCep = (i) => {i.addEventListener('input', function(e){let v=e.target.value.replace(/\D/g,'').substring(0,8);v=v.replace(/^(\d{5})(\d)/,'$1-$2');e.target.value=v;});};
             mascaraCep(document.getElementById('cep'));
             mascaraCep(document.getElementById('cepEmpresa'));
             const mascaraValor = (input) => {
                input.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    if (!value) { e.target.value = ''; return; }
                    let valorNumerico = (parseInt(value) || 0) / 100;
                    let valorFormatado = valorNumerico.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    if (!e.target.value.startsWith('R$ ') && valorFormatado !== '0,00') { e.target.value = 'R$ ' + valorFormatado; }
                    else if (e.target.value.startsWith('R$ ') && valorFormatado !== '0,00') { e.target.value = 'R$ ' + valorFormatado; }
                    else if (valorFormatado === '0,00' && e.target.value !== '') { e.target.value = ''; }
                    else if (valorFormatado !== '0,00') { e.target.value = 'R$ ' + valorFormatado; }
                    if (e.target.value === 'R$ NaN') { e.target.value = ''; }
                });
                input.addEventListener('blur', function(e) {
                     let value = e.target.value.replace(/\D/g, '');
                     if (value && parseInt(value) > 0) {
                         value = ((parseInt(value) || 0) / 100).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                         e.target.value = value;
                     } else { e.target.value = ''; }
                });
            };
            mascaraValor(document.getElementById('valorTotal'));
            mascaraValor(document.getElementById('entradaDigital'));
            mascaraValor(document.getElementById('rendaMensal'));

            // Inicialização
            togglePessoaJuridica();
            atualizarTextoBotao();
        });
    </script>
</body>
</html>
